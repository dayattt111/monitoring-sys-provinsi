<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Kinerja Satuan Kerja</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="bg-overlay">
    <div class="max-w-7xl mx-auto px-4 md:px-8">

        <!-- HEADER -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-5xl font-extrabold text-dark-contrast mb-2 title-shadow flex items-center justify-center gap-3">
                <span class="inline-flex items-center justify-center w-12 h-12 md:w-14 md:h-14 rounded-2xl bg-black/70 border border-white/20 shadow-xl overflow-hidden">
                    <img src="kejag.png" class="w-8 h-8 md:w-10 md:h-10 object-contain" alt="Logo">
                </span>
                <span>Dashbord Monitoring Jaga Desa Jawa Timur</span>
            </h1>

            <p class="text-muted-contrast text-base md:text-lg title-shadow">
                <span class="font-semibold ">
                    Periode: 1 - <span id="current-date"></span>
                </span>
            </p>
        </header>

        <!-- TOP STATS CARDS -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mb-8" id="topStatsContainer">
            <div data-menu-id="jaga_budaya" class="glass-card p-5 rounded-3xl border border-white/15 hover:border-cyan-400/50 transition-all top-stat-card">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-cyan-600 mb-2 flex items-center gap-2">
                            <i data-lucide="book-open" class="w-5 h-5"></i>
                            Jaga Budaya
                        </h3>
                        <div class="text-4xl font-extrabold text-gray-900 mb-2" id="totalJagaBudaya">0</div>
                        <div class="text-xs text-gray-600" id="breakdownJagaBudaya">Loading...</div>
                    </div>
                    <div class="w-20 h-20">
                        <canvas id="chartJagaBudaya"></canvas>
                    </div>
                </div>
            </div>

            <div data-menu-id="pengawasan_ormas" class="glass-card p-5 rounded-3xl border border-white/15 hover:border-purple-400/50 transition-all top-stat-card">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-purple-600 mb-2 flex items-center gap-2">
                            <i data-lucide="users" class="w-5 h-5"></i>
                            Pengawasan Ormas
                        </h3>
                        <div class="text-4xl font-extrabold text-gray-900 mb-2" id="totalPengawasanOrmas">0</div>
                        <div class="text-xs text-gray-600" id="breakdownPengawasanOrmas">Loading...</div>
                    </div>
                    <div class="w-20 h-20">
                        <canvas id="chartPengawasanOrmas"></canvas>
                    </div>
                </div>
            </div>

            <div data-menu-id="pemantauan_lingkungan" class="glass-card p-5 rounded-3xl border border-white/15 hover:border-green-400/50 transition-all top-stat-card">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-green-600 mb-2 flex items-center gap-2">
                            <i data-lucide="truck" class="w-5 h-5"></i>
                            Pemantauan Lingkungan
                        </h3>
                        <div class="text-4xl font-extrabold text-gray-900 mb-2" id="totalPemantauanLingkungan">0</div>
                        <div class="text-xs text-gray-600" id="breakdownPemantauanLingkungan">Loading...</div>
                    </div>
                    <div class="w-20 h-20">
                        <canvas id="chartPemantauanLingkungan"></canvas>
                    </div>
                </div>
            </div>

            <div data-menu-id="pemantauan_orang_asing" class="glass-card p-5 rounded-3xl border border-white/15 hover:border-yellow-400/50 transition-all top-stat-card">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-yellow-600 mb-2 flex items-center gap-2">
                            <i data-lucide="map-pin" class="w-5 h-5"></i>
                            Pemantauan Orang Asing
                        </h3>
                        <div class="text-4xl font-extrabold text-gray-900 mb-2" id="totalPemantauanOrangAsing">0</div>
                        <div class="text-xs text-gray-600" id="breakdownPemantauanOrangAsing">Loading...</div>
                    </div>
                    <div class="w-20 h-20">
                        <canvas id="chartPemantauanOrangAsing"></canvas>
                    </div>
                </div>
            </div>

            <div data-menu-id="aset_desa" class="glass-card p-5 rounded-3xl border border-white/15 hover:border-blue-400/50 transition-all top-stat-card">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-blue-600 mb-2 flex items-center gap-2">
                            <i data-lucide="plus-square" class="w-5 h-5"></i>
                            Aset Desa/Kelurahan
                        </h3>
                        <div class="text-4xl font-extrabold text-gray-900 mb-2" id="totalAsetDesa">0</div>
                        <div class="text-xs text-gray-600" id="breakdownAsetDesa">Loading...</div>
                    </div>
                    <div class="w-20 h-20">
                        <canvas id="chartAsetDesa"></canvas>
                    </div>
                </div>
            </div>

            <div data-menu-id="kasus_penyelewengan" class="glass-card p-5 rounded-3xl border border-white/15 hover:border-red-400/50 transition-all top-stat-card">
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-bold text-red-600 mb-2 flex items-center gap-2">
                            <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            Kasus Penyelewengan
                        </h3>
                        <div class="text-4xl font-extrabold text-gray-900 mb-2" id="totalKasusPenyelewengan">0</div>
                        <div class="text-xs text-gray-600" id="breakdownKasusPenyelewengan">Loading...</div>
                    </div>
                    <div class="w-20 h-20">
                        <canvas id="chartKasusPenyelewengan"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- DISPARITAS & MAP SECTION -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            <!-- DISPARITAS TUNTUTAN DAN PUTUSAN -->
            <div class="glass-card p-5 rounded-3xl border border-white/15">
                <div class="flex items-center justify-between mb-4">
                    <h5 class="text-dark-contrast text-xl font-bold flex items-center gap-2">
                        <i data-lucide="bar-chart-3" class="w-5 h-5 text-amber-300"></i>
                        <span>Disparitas Kasus</span>
                    </h5>
                    <button class="text-gray-500 hover:text-gray-800 transition no-print" onclick="toggleFullScreen('disparitas-section')">
                        <i data-lucide="maximize-2" class="w-5 h-5"></i>
                    </button>
                </div>
                
                <div id="disparitas-section" class="space-y-3">
                    <div class="text-center mb-3">
                        <div class="text-lg font-bold text-cyan-600" id="currentSatker">KEJAKSAAN NEGERI SURABAYA</div>
                        <div class="text-xs text-gray-500">Kabupaten dengan Data Terbanyak</div>
                        <!-- Auto-rotation indicator -->
                        <div class="mt-2 inline-flex items-center gap-2 px-3 py-1 bg-cyan-50 border border-cyan-300 rounded-full text-xs">
                            <div class="w-2 h-2 bg-cyan-500 rounded-full animate-pulse"></div>
                            <span class="text-cyan-700 font-semibold">Auto-Rotation Active</span>
                            <span class="text-gray-600" id="rotationTimer">5s</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 text-xs mb-3">
                        <div class="bg-emerald-50 border border-emerald-300 rounded-xl p-3">
                            <div class="text-emerald-700 font-semibold mb-1">Kasus Tertinggi</div>
                            <div class="text-gray-900 text-lg font-bold" id="kasusTertinggi">156 Kasus</div>
                        </div>
                        <div class="bg-amber-50 border border-amber-300 rounded-xl p-3">
                            <div class="text-amber-700 font-semibold mb-1">Kasus Terendah</div>
                            <div class="text-gray-900 text-lg font-bold" id="kasusTerendah">23 Kasus</div>
                        </div>
                    </div>

                    <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4" style="height: 280px;">
                        <canvas id="disparitasChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- TREN PERKARA PER DAERAH (MAP) -->
            <div class="glass-card p-5 rounded-3xl border border-white/15">
                <div class="flex items-center justify-between mb-4">
                    <h5 class="text-dark-contrast text-xl font-bold flex items-center gap-2">
                        <i data-lucide="map-pin" class="w-5 h-5 text-green-300"></i>
                        <span>Tren Per Daerah</span>
                    </h5>
                    <button class="text-gray-500 hover:text-gray-800 transition no-print" onclick="toggleFullScreen('map-section')">
                        <i data-lucide="maximize-2" class="w-5 h-5"></i>
                    </button>
                </div>

                <div id="map-section" class="space-y-3">
                    <div class="bg-gray-50 border border-gray-200 rounded-2xl overflow-hidden" style="height: 280px;">
                        <div id="mapLeaflet" style="height: 100%; width: 100%;"></div>
                    </div>

                    <div class="bg-blue-50 border border-blue-200 rounded-2xl p-4">
                        <h6 class="font-bold text-cyan-700 mb-3" id="regionName">KEJAKSAAN NEGERI SURABAYA</h6>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Jaga Budaya:</span>
                                <span class="font-bold text-gray-900" id="statJagaBudaya">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Pengawasan Ormas:</span>
                                <span class="font-bold text-gray-900" id="statPengawasanOrmas">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Pemantauan Lingkungan:</span>
                                <span class="font-bold text-gray-900" id="statPemantauanLingkungan">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Orang Asing:</span>
                                <span class="font-bold text-gray-900" id="statOrangAsing">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Aset Desa:</span>
                                <span class="font-bold text-gray-900" id="statAsetDesa">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Penyelewengan:</span>
                                <span class="font-bold text-gray-900" id="statPenyelewengan">-</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- FILTER -->
        <div class="glass-card p-6 md:p-7 rounded-3xl mb-8 no-print border border-white/15">
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="search" class="w-5 h-5 text-sky-300"></i>
                <h5 class="text-dark-contrast text-xl font-bold">Filter Laporan</h5>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div class="col-span-1">
                    <p class="text-xs font-semibold text-gray-700 mb-1 uppercase tracking-wide">Tanggal Laporan</p>
                    <input type="date" id="filter-date"
                           class="input-dark w-full px-3 py-2.5 text-sm shadow-md">
                </div>

                <div class="col-span-1">
                    <p class="text-xs font-semibold text-gray-700 mb-1 uppercase tracking-wide">Satuan Kerja</p>
                    <select id="filter-unit"
                            class="select-dark w-full px-3 py-2.5 text-sm shadow-md">
                        <option value="">Semua Unit</option>
                    </select>
                </div>

                <div class="col-span-1 flex gap-2">
                    <button id="apply-filter-btn"
                            class="btn-yellow flex-1 px-4 py-2.5 text-sm inline-flex items-center justify-center gap-2">
                        <i data-lucide="filter" class="w-4 h-4"></i>
                        <span>Terapkan Filter</span>
                    </button>
                </div>

                <div class="col-span-1 flex gap-2">
                    <button id="reset-filter-btn"
                            class="btn-outline-dark flex-1 px-4 py-2.5 text-sm inline-flex items-center justify-center gap-2">
                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i>
                        <span>Reset Filter</span>
                    </button>
                    <button id="print-btn"
                            class="btn-cyan flex-1 px-5 py-2.5 text-sm inline-flex items-center justify-center gap-2">
                        <i data-lucide="printer" class="w-5 h-5"></i>
                        <span>Cetak Laporan</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- SUMMARY CARDS -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
            <div id="total-units-card"
                 class="summary-card p-5 text-center cursor-pointer">
                <i data-lucide="layers" class="w-9 h-9 text-yellow-500 mx-auto mb-3"></i>
                <h5 class="text-sm md:text-base font-semibold text-gray-700">Total Satuan Kerja</h5>
                <h3 id="card-total-units" class="text-3xl md:text-4xl font-extrabold text-gray-900 mt-1">0</h3>
                <p class="text-xs md:text-sm text-gray-600 mt-1">
                    Unit terdaftar Â· klik untuk lihat daftar & grafik
                </p>
            </div>

            <div id="compliant-card" data-status="compliant"
                 class="summary-card p-5 text-center cursor-pointer">
                <i data-lucide="check-circle" class="w-9 h-9 text-emerald-500 mx-auto mb-3"></i>
                <h5 class="text-sm md:text-base font-semibold text-gray-700">Unit Selesai Input</h5>
                <h3 id="card-units-compliant" class="text-3xl md:text-4xl font-extrabold text-gray-900 mt-1">0</h3>
                <p class="text-xs md:text-sm text-gray-600 mt-1">
                    Klik untuk lihat daftar & detail kegiatan
                </p>
            </div>

            <div id="pending-card" data-status="pending"
                 class="summary-card p-5 text-center cursor-pointer">
                <i data-lucide="loader" class="w-9 h-9 text-amber-500 mx-auto mb-3"></i>
                <h5 class="text-sm md:text-base font-semibold text-gray-700">Unit Belum Selesai Input</h5>
                <h3 id="card-units-pending" class="text-3xl md:text-4xl font-extrabold text-gray-900 mt-1">0</h3>
                <p class="text-xs md:text-sm text-gray-600 mt-1">
                    Klik untuk lihat daftar pending
                </p>
            </div>

            <div class="summary-card p-5 text-center">
                <i data-lucide="trending-up" class="w-9 h-9 text-red-500 mx-auto mb-3"></i>
                <h5 class="text-sm md:text-base font-semibold text-gray-700">Rata-rata Kepatuhan</h5>
                <h3 id="card-compliance-rate" class="text-3xl md:text-4xl font-extrabold text-gray-900 mt-1">0%</h3>
                <p class="text-xs md:text-sm text-gray-600 mt-1">Per menu aktif</p>
            </div>
        </div>

        <!-- MENU UTAMA -->
        <div class="glass-card p-5 rounded-3xl border border-white/15 mb-8">
            <h5 class="text-dark-contrast text-xl font-bold flex items-center gap-2">
                <i data-lucide="list" class="w-5 h-5 text-sky-500"></i>
                <span>Menu Utama</span>
            </h5>
            <p class="text-xs text-gray-600 mt-1">
                Pilih menu untuk melihat grafik & status input semua Satker pada menu tersebut.
            </p>

            <div id="main-menu-container"
                 class="mt-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                <!-- tombol menu diisi lewat JS -->
            </div>
        </div>

        <!-- CHART + BULANAN -->
        <div class="space-y-6 mb-8">
            <!-- Chart Batang Full -->
            <div class="glass-card p-5 rounded-3xl border border-white/15">
                <div class="flex flex-col gap-1 mb-3">
                    <h5 class="text-dark-contrast text-xl font-bold flex items-center gap-2">
                        <i data-lucide="layout-grid" class="w-5 h-5 text-sky-500"></i>
                        <span>Grafik Kepatuhan per Satker</span>
                    </h5>
                    <p class="text-xs text-gray-600">
                        Menu aktif:
                        <span id="active-menu-label" class="font-semibold text-sky-600">
                            Jaksa Garda Desa / Kelurahan
                        </span>
                    </p>
                </div>

                <h6 class="text-sm font-semibold text-gray-700 mb-2 border-b border-gray-200 pb-1">
                    Target vs Aktual per Satker
                </h6>
                <div class="relative w-full overflow-x-auto bg-gray-50 rounded-2xl p-2 border border-gray-200">
                    <div id="performanceBarChartContainer" style="min-height: 400px;">
                        <canvas id="performanceBarChart"></canvas>
                    </div>
                </div>

            </div>

            <!-- Bulanan (dummy, tetap) -->
            <div class="glass-card p-5 rounded-3xl border border-white/15">
                <h5 class="text-dark-contrast text-xl font-bold mb-4 flex items-center gap-2">
                    <i data-lucide="calendar-check" class="w-5 h-5 text-sky-500"></i>
                    <span>Status Input Bulanan (Tren)</span>
                </h5>
                <div id="monthly-status-list" class="space-y-3">
                    <div class="p-3 rounded-2xl border border-emerald-300 bg-gradient-to-r from-emerald-50 to-emerald-100/50">
                        <p class="text-sm text-gray-800 font-semibold">Bulan Ini (Des 2025)</p>
                        <div class="flex justify-between items-center mt-1 gap-2">
                            <span class="text-xs text-emerald-700 font-medium">95% Kepatuhan</span>
                            <div class="w-1/2 bg-white rounded-full h-2.5 border border-emerald-200">
                                <div class="bg-emerald-500 h-2.5 rounded-full" style="width: 95%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 rounded-2xl border border-amber-300 bg-gradient-to-r from-amber-50 to-amber-100/50">
                        <p class="text-sm text-gray-800 font-semibold">Bulan Lalu (Nov 2025)</p>
                        <div class="flex justify-between items-center mt-1 gap-2">
                            <span class="text-xs text-amber-700 font-medium">78% Kepatuhan</span>
                            <div class="w-1/2 bg-white rounded-full h-2.5 border border-amber-200">
                                <div class="bg-amber-500 h-2.5 rounded-full" style="width: 78%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-xs md:text-sm text-gray-600 mt-4">
                    Kepatuhan dihitung dari rata-rata total input per unit dibandingkan target per bulan.
                </p>
            </div>
        </div>

        <!-- TABEL DETAIL -->
        <div class="glass-card p-5 rounded-3xl border border-white/15">
            <div class="flex flex-col gap-1 mb-4">
                <h5 class="text-dark-contrast text-xl font-bold flex items-center gap-2">
                    <i data-lucide="list-checks" class="w-5 h-5 text-sky-500"></i>
                    <span>Detail Status Input Harian</span>
                </h5>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider rounded-tl-lg">
                            Satuan Kerja (SKPD)
                        </th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700 uppercase tracking-wider">Target</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700 uppercase tracking-wider">Aktual</th>
                        <th class="px-4 py-3 text-center font-semibold text-gray-700 uppercase tracking-wider">Status</th>
                        <th class="px-4 py-3 text-left font-semibold text-gray-700 uppercase tracking-wider rounded-tr-lg">
                            Waktu Terakhir Input
                        </th>
                    </tr>
                    </thead>
                    <tbody id="unit-status-body" class="divide-y divide-gray-100 bg-white">
                    </tbody>
                </table>
                <div id="no-data-message" class="text-center py-8 text-gray-600 hidden">
                    <i data-lucide="info" class="inline-block w-6 h-6 mr-2"></i>
                    Tidak ada data Satuan Kerja yang sesuai dengan filter.
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="flex flex-col sm:flex-row items-center justify-between gap-3 mt-4 pt-4 border-t border-gray-200">
                <div class="text-sm text-gray-700">
                    Menampilkan <span class="font-semibold text-cyan-600" id="pageInfo">1-10</span> dari <span class="font-semibold text-cyan-600" id="totalRecords">0</span> data
                </div>
                <div class="flex items-center gap-2">
                    <button id="prevPage" onclick="changePage(-1)" 
                            class="px-3 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 border border-cyan-300 rounded-lg text-white text-sm font-medium hover:from-cyan-600 hover:to-blue-600 transition disabled:opacity-30 disabled:cursor-not-allowed disabled:from-gray-400 disabled:to-gray-500 flex items-center gap-1">
                        <i data-lucide="chevron-left" class="w-4 h-4"></i>
                        <span class="hidden sm:inline">Prev</span>
                    </button>
                    <div class="px-4 py-2 bg-white border border-cyan-300 rounded-lg">
                        <span class="text-sm text-gray-700">
                            <span class="font-bold text-cyan-600" id="currentPage">1</span>
                            <span class="text-gray-400">/</span>
                            <span class="text-gray-700" id="totalPages">1</span>
                        </span>
                    </div>
                    <button id="nextPage" onclick="changePage(1)" 
                            class="px-3 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 border border-cyan-300 rounded-lg text-white text-sm font-medium hover:from-cyan-600 hover:to-blue-600 transition disabled:opacity-30 disabled:cursor-not-allowed disabled:from-gray-400 disabled:to-gray-500 flex items-center gap-1">
                        <span class="hidden sm:inline">Next</span>
                        <i data-lucide="chevron-right" class="w-4 h-4"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- STATISTIK PERKARA -->
        <div class="glass-card p-5 rounded-3xl border border-white/15 mt-8">
            <div class="flex items-center justify-between mb-4">
                <h5 class="text-dark-contrast text-xl font-bold flex items-center gap-2">
                    <i data-lucide="bar-chart-4" class="w-5 h-5 text-purple-500"></i>
                    <span>Statistik Perkara</span>
                </h5>
                <button class="text-gray-500 hover:text-gray-800 transition no-print" onclick="toggleFullScreen('statistik-perkara-section')">
                    <i data-lucide="maximize-2" class="w-5 h-5"></i>
                </button>
            </div>

            <div id="statistik-perkara-section" class="overflow-x-auto">
                <table class="min-w-full text-sm border-collapse">
                    <thead>
                        <tr>
                            <th rowspan="2" class="px-4 py-3 text-left font-bold text-cyan-700 bg-gray-100 border border-gray-300" id="tableKabupaten">
                                Kabupaten/Kota
                            </th>
                            <th colspan="3" class="px-4 py-2 text-center font-bold text-purple-700 bg-purple-100 border border-gray-300">
                                Jaga Budaya
                            </th>
                            <th colspan="3" class="px-4 py-2 text-center font-bold text-pink-700 bg-pink-100 border border-gray-300">
                                Pengawasan Ormas
                            </th>
                            <th colspan="3" class="px-4 py-2 text-center font-bold text-green-700 bg-green-100 border border-gray-300">
                                Pemantauan Lingkungan
                            </th>
                        </tr>
                        <tr>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Total</th>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Selesai</th>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Proses</th>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Total</th>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Selesai</th>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Proses</th>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Total</th>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Selesai</th>
                            <th class="px-3 py-2 text-center text-xs text-gray-700 bg-gray-50 border border-gray-300">Proses</th>
                        </tr>
                    </thead>
                    <tbody id="statistikPerkaraBody" class="bg-white">
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- =============== MODALS =============== -->

<!-- MODAL: DAFTAR SEMUA SATUAN KERJA -->
<div id="unit-list-modal"
     class="fixed inset-0 z-40 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
    <div class="w-full max-w-3xl max-height-[80vh] bg-white rounded-3xl shadow-2xl border border-gray-300 p-6 overflow-hidden">
        <div class="flex items-center justify-between mb-4 border-b border-gray-200 pb-3">
            <div class="flex items-center gap-3">
                <i data-lucide="check-square" class="w-6 h-6 text-sky-600"></i>
                <h3 class="text-xl md:text-2xl font-bold text-gray-900">
                    Daftar Semua Satuan Kerja
                </h3>
            </div>
            <button id="close-modal-btn"
                    class="p-2 rounded-full hover:bg-gray-100 text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <p class="text-sm text-gray-600 mb-3">
            Klik nama Satuan Kerja untuk melihat grafik kinerja 20 hari terakhir.
        </p>

        <div id="unit-list-content"
             class="space-y-2 overflow-y-auto pr-2 max-h-[60vh]">
            <!-- Daftar satker diisi dari JS -->
        </div>
    </div>
</div>

<!-- MODAL: SATKER SELESAI / BELUM SELESAI -->
<div id="satker-modal"
     class="fixed inset-0 z-40 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
    <div class="w-full max-w-3xl max-h-[80vh] bg-white rounded-3xl shadow-2xl border border-gray-300 p-6 overflow-hidden">
        <div class="flex items-center justify-between mb-4 border-b border-gray-200 pb-3">
            <h3 id="satker-modal-title"
                class="text-xl md:text-2xl font-bold text-gray-900">
                Daftar Satuan Kerja
            </h3>
            <button id="close-satker-modal-btn"
                    class="p-2 rounded-full hover:bg-gray-100 text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div id="satker-list-container"
             class="space-y-3 overflow-y-auto max-h-[60vh] pr-2">
            <!-- Diisi dari JS -->
        </div>
    </div>
</div>

<!-- MODAL: DETAIL KEGIATAN SATKER -->
<div id="detail-kegiatan-modal"
     class="fixed inset-0 z-40 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
    <div class="w-full max-w-2xl max-h-[80vh] bg-white rounded-3xl shadow-2xl border border-gray-300 p-6 overflow-hidden">
        <div class="flex items-center justify-between mb-4 border-b border-gray-200 pb-3">
            <h3 id="detail-kegiatan-title"
                class="text-xl md:text-2xl font-bold text-gray-900">
                Detail Kegiatan
            </h3>
            <button onclick="hideDetailKegiatan()"
                    class="p-2 rounded-full hover:bg-gray-100 text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div id="detail-kegiatan-content"
             class="space-y-4 overflow-y-auto max-h-[60vh] pr-2">
            <!-- Kegiatan diisi dari JS -->
        </div>
    </div>
</div>

<!-- MODAL: GRAFIK HISTORI 20 HARI SATKER -->
<div id="satker-chart-modal"
     class="fixed inset-0 z-40 hidden items-center justify-center bg-black/70 backdrop-blur-sm">
    <div class="w-full max-w-4xl max-h-[85vh] bg-white rounded-3xl shadow-2xl border border-gray-300 p-6 overflow-hidden">
        <div class="flex items-center justify-between mb-4 border-b border-gray-200 pb-3">
            <h3 id="satker-chart-title"
                class="text-xl md:text-2xl font-bold text-gray-900">
                Grafik Kinerja Satker
            </h3>
            <button id="close-satker-chart-modal-btn"
                    class="p-2 rounded-full hover:bg-gray-100 text-gray-600">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <div class="space-y-4">
            <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4">
                <div class="relative w-full h-[260px]">
                    <canvas id="satkerHistoryChart"></canvas>
                </div>
            </div>

            <p id="satker-missing-days"
               class="text-sm text-gray-700">
                <!-- Info hari tanpa input diisi dari JS -->
            </p>
        </div>
    </div>
</div>

<script>
    const hasLucide = typeof lucide !== "undefined";
    if (hasLucide) lucide.createIcons();

    /* ===================== DATA DASAR SATKER ===================== */

    const CSV_CONTENT = `SATUAN KERJA
KEJAKSAAN NEGERI PAMEKASAN
KEJAKSAAN NEGERI PONOROGO
KEJAKSAAN NEGERI MAGETAN
KEJAKSAAN NEGERI SITUBONDO
KEJAKSAAN NEGERI BOJONEGORO
KEJAKSAAN NEGERI JOMBANG
KEJAKSAAN NEGERI JEMBER
KEJAKSAAN NEGERI KABUPATEN MALANG
KEJAKSAAN NEGERI NGAWI
KEJAKSAAN NEGERI PACITAN
KEJAKSAAN NEGERI KABUPATEN MOJOKERTO
KEJAKSAAN NEGERI GRESIK
KEJAKSAAN NEGERI BANYUWANGI
KEJAKSAAN NEGERI KABUPATEN MADIUN
KEJAKSAAN NEGERI BANGKALAN
KEJAKSAAN NEGERI BONDOWOSO
KEJAKSAAN NEGERI LUMAJANG
KEJAKSAAN NEGERI TANJUNG PERAK
KEJAKSAAN NEGERI SURABAYA
KEJAKSAAN NEGERI TUBAN
KEJAKSAAN NEGERI TULUNG AGUNG
KEJAKSAAN NEGERI KOTA KEDIRI
KEJAKSAAN NEGERI BATU
KEJAKSAAN NEGERI KABUPATEN PASURUAN
KEJAKSAAN NEGERI BLITAR
KEJAKSAAN NEGERI SAMPANG
KEJAKSAAN NEGERI SIDOARJO
KEJAKSAAN NEGERI SUMENEP
KEJAKSAAN NEGERI NGANJUK
KEJAKSAAN NEGERI KABUPATEN PROBOLINGGO
KEJAKSAAN NEGERI KOTA MALANG
KEJAKSAAN NEGERI TRENGGALEK`;

    function parseSatuanKerja(csv) {
        const lines = csv.split('\n').map(l => l.trim()).filter(l => l.length > 0);
        if (lines.length > 0 && lines[0].toUpperCase() === 'SATUAN KERJA') {
            return lines.slice(1);
        }
        return lines;
    }

    const SATUAN_KERJA_NAMES = parseSatuanKerja(CSV_CONTENT);

    /* ===================== MOCK DATA KEGIATAN UNTUK MODAL DETAIL ===================== */

   const MOCK_KEGIATAN = {
    "KEJAKSAAN NEGERI SITUBONDO": [
        {
            nama: "Sosialisasi Layanan Hukum",
            deskripsi: "Kegiatan sosialisasi layanan hukum kepada masyarakat desa binaan.",
            waktu_mulai: "13:00",
            waktu_selesai: "15:00",
            dokumentasi: "https://picsum.photos/900/500?random=4"
        }
    ],
    "KEJAKSAAN NEGERI JEMBER": [
        {
            nama: "Monitoring Pelayanan Publik",
            deskripsi: "Monitoring kualitas pelayanan publik dan penyerapan aspirasi masyarakat.",
            waktu_mulai: "09:00",
            waktu_selesai: "10:30",
            dokumentasi: "https://picsum.photos/900/500?random=2"
        }
    ],
    "KEJAKSAAN NEGERI PACITAN": [
        {
            nama: "Rapat Koordinasi Internal",
            deskripsi: "Rapat koordinasi antara jaksa garda desa, pimpinan, dan perangkat desa.",
            waktu_mulai: "11:00",
            waktu_selesai: "12:00",
            dokumentasi: "https://picsum.photos/900/500?random=3"
        }
    ],
    // âžœ CONTOH: KEJAKSAAN NEGERI JOMBANG
    "KEJAKSAAN NEGERI JOMBANG": [
        {
            nama: "Penyuluhan Hukum di Desa Jombang",
            deskripsi: "Penyuluhan mengenai pencegahan tindak pidana korupsi dana desa kepada aparat dan masyarakat.",
            waktu_mulai: "08:30",
            waktu_selesai: "11:00",
            dokumentasi: "https://picsum.photos/900/500?random=10"
        }
    ]
    // Satker lain tinggal ditambahkan dengan format yang sama
};


    /* ===================== MENU UTAMA ===================== */

    const MAIN_MENUS = [
        { id: 'jaksa_garda',           title: 'Jaksa Garda',           subtitle: 'Desa / Kelurahan', icon: 'clipboard-list' },
        { id: 'jaga_budaya',           title: 'Jaga Budaya',           subtitle: '',                  icon: 'book-open' },
        { id: 'pengawasan_ormas',      title: 'Pengawasan Ormas / LSM',subtitle: '/ Paguyuban',       icon: 'users' },
        { id: 'pemantauan_lingkungan', title: 'Pemantauan Lingkungan', subtitle: '',                  icon: 'truck' },
        { id: 'pemantauan_orang_asing',title: 'Pemantauan Orang Asing',subtitle: '',                  icon: 'map-pin' },
        { id: 'aset_desa',             title: 'Aset Desa/Kelurahan',   subtitle: 'Selain Tanah dan Bangunan', icon: 'plus-square' },
        { id: 'kasus_penyelewengan',   title: 'Kasus Penyelewengan',   subtitle: 'oleh Perangkat Desa/Kelurahan', icon: 'alert-triangle' }
    ];

    function getMenuLabel(menuId) {
        const menu = MAIN_MENUS.find(m => m.id === menuId);
        if (!menu) return '';
        return menu.subtitle ? `${menu.title} ${menu.subtitle}` : menu.title;
    }

    /* ===================== MOCK DATA PER MENU ===================== */

    function generateMockDataForMenu(names) {
        const today = new Date();
        const result = [];

        names.forEach(name => {
            const history = [];

            for (let i = 19; i >= 0; i--) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);

                const target = Math.floor(Math.random() * 4) + 3;   // 3â€“6
                const hasInput = Math.random() < 0.7;               // 70% hari punya input
                const actual = hasInput ? Math.floor(Math.random() * (target + 1)) : 0;

                history.push({
                    date: d.toISOString().split('T')[0],
                    target,
                    actual
                });
            }

            const todayRecord = history[history.length - 1];

            // cari tanggal terakhir yang benar-benar ada input (>0)
            let lastInputDate = null;
            for (let i = history.length - 1; i >= 0; i--) {
                if (history[i].actual > 0) {
                    lastInputDate = history[i].date;
                    break;
                }
            }

            const hour = 8 + Math.floor(Math.random() * 9);
            const minute = Math.floor(Math.random() * 60);
            const lastInputTime = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}:00`;

            result.push({
                name,
                target: todayRecord.target,
                actual: todayRecord.actual,
                lastInputDate,
                lastInputTime,
                history
            });
        });

        return result;
    }

    // Data per menu: { menuId: [ {name, target, actual, ...}, ... ] }
    const MENU_DATA = {};
    
    // Setiap menu punya jumlah data yang berbeda (dalam ribuan)
    const menuDataCounts = {
        'jaksa_garda': 1245,         
        'jaga_budaya': 2387,         
        'pengawasan_ormas': 3156,    
        'pemantauan_lingkungan': 1845, 
        'pemantauan_orang_asing': 1523,
        'aset_desa': 4234,            
        'kasus_penyelewengan': 1112    
    };

    MAIN_MENUS.forEach(menu => {
        const count = menuDataCounts[menu.id] || 32;
        const names = [];
        
        // Generate nama-nama unik untuk setiap menu
        for (let i = 0; i < count; i++) {
            if (i < SATUAN_KERJA_NAMES.length) {
                names.push(SATUAN_KERJA_NAMES[i]);
            } else {
                // Buat nama tambahan untuk data yang lebih banyak
                const baseIndex = i % SATUAN_KERJA_NAMES.length;
                const suffix = Math.floor(i / SATUAN_KERJA_NAMES.length) + 1;
                names.push(`${SATUAN_KERJA_NAMES[baseIndex]} - Data ${suffix}`);
            }
        }
        
        MENU_DATA[menu.id] = generateMockDataForMenu(names);
    });

    /* ===================== STATE GLOBAL ===================== */

    // Set default menu to jaga_budaya (menu kedua) karena jaksa_garda tidak punya CSV
    let currentMenuId = 'jaga_budaya';  // MAIN_MENUS[1].id
    let currentData = [...MENU_DATA[currentMenuId]];
    let currentStatusFilter = 'all'; // 'all' | 'compliant' | 'pending'
    let performanceBarChartInstance = null;
    let satkerHistoryChartInstance = null;
    let autoRotateInterval = null;  // For auto-rotation timer

    /* ===================== UTIL ===================== */

    function formatDateLong(date) {
        const options = { year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('id-ID', options);
    }

    function getLastInputDateDisplay(unit) {
        if (!unit.lastInputDate) return '-';
        const [y, m, d] = unit.lastInputDate.split('-');
        return `${d}-${m}-${y}`;
    }

    /* ===================== RENDER SUMMARY ===================== */

    function renderSummary() {
        const baseData = MENU_DATA[currentMenuId];
        const totalUnits = baseData.length;
        const unitsCompliant = baseData.filter(u => u.actual >= u.target).length;
        const unitsPending = baseData.filter(u => u.actual < u.target).length;

        const totalTarget = baseData.reduce((sum, u) => sum + u.target, 0);
        const totalActual = baseData.reduce((sum, u) => sum + u.actual, 0);

        let complianceRate = 0;
        if (totalTarget > 0) {
            complianceRate = Math.min((totalActual / totalTarget) * 100, 100);
        }

        document.getElementById('card-total-units').textContent = totalUnits;
        document.getElementById('card-units-compliant').textContent = unitsCompliant;
        document.getElementById('card-units-pending').textContent = unitsPending;
        document.getElementById('card-compliance-rate').textContent = `${complianceRate.toFixed(0)}%`;

        document.querySelectorAll('.summary-card[data-status]').forEach(card => {
            const status = card.getAttribute('data-status');
            card.classList.remove('ring-4', 'ring-emerald-400/50', 'ring-amber-400/50');
            if (status === currentStatusFilter) {
                card.classList.add('ring-4', status === 'compliant'
                    ? 'ring-emerald-400/50'
                    : 'ring-amber-400/50');
            }
        });
    }

    /* ===================== RENDER TABEL ===================== */

    let currentPageNum = 1;
    let itemsPerPage = 10;
    let allTableData = [];

    function renderTable(data) {
        allTableData = data;
        renderTablePage();
    }

    function renderTablePage() {
        const tbody = document.getElementById('unit-status-body');
        const noDataMsg = document.getElementById('no-data-message');
        tbody.innerHTML = '';

        if (!allTableData.length) {
            noDataMsg.classList.remove('hidden');
            document.getElementById('totalRecords').textContent = '0';
            document.getElementById('currentPage').textContent = '1';
            document.getElementById('totalPages').textContent = '1';
            document.getElementById('pageInfo').textContent = '0-0';
            return;
        }
        noDataMsg.classList.add('hidden');

        // Sort data
        const sortedData = [...allTableData].sort((a, b) => {
            const aDone = a.actual >= a.target;
            const bDone = b.actual >= b.target;
            if (aDone && !bDone) return -1;
            if (!aDone && bDone) return 1;
            return a.name.localeCompare(b.name);
        });

        // Calculate pagination
        const totalItems = sortedData.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const startIndex = (currentPageNum - 1) * itemsPerPage;
        const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
        const pageData = sortedData.slice(startIndex, endIndex);

        // Update pagination info
        document.getElementById('totalRecords').textContent = totalItems.toLocaleString('id-ID');
        document.getElementById('currentPage').textContent = currentPageNum;
        document.getElementById('totalPages').textContent = totalPages;
        document.getElementById('pageInfo').textContent = `${startIndex + 1}-${endIndex}`;

        // Enable/disable buttons
        document.getElementById('prevPage').disabled = currentPageNum === 1;
        document.getElementById('nextPage').disabled = currentPageNum === totalPages;

        // Render table rows
        pageData.forEach(unit => {
            const isCompliant = unit.actual >= unit.target;
            const statusBadge = isCompliant
                ? `<span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium badge-emerald">
                        <i data-lucide="check" class="w-4 h-4 mr-1"></i> Selesai
                   </span>`
                : `<span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium badge-amber">
                        <i data-lucide="alert-triangle" class="w-4 h-4 mr-1"></i> Pending
                   </span>`;

            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-100 transition';
            row.innerHTML = `
                <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${unit.name}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center text-gray-700">
                    ${unit.target}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center font-bold ${isCompliant ? 'text-emerald-600' : 'text-amber-600'}">
                    ${unit.actual}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-center">
                    ${statusBadge}
                </td>
                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">
                    ${getLastInputDateDisplay(unit)} â€¢ ${unit.lastInputTime}
                </td>
            `;
            tbody.appendChild(row);
        });

        if (hasLucide) lucide.createIcons();
    }

    function changePage(direction) {
        const totalPages = Math.ceil(allTableData.length / itemsPerPage);
        currentPageNum += direction;
        
        if (currentPageNum < 1) currentPageNum = 1;
        if (currentPageNum > totalPages) currentPageNum = totalPages;
        
        renderTablePage();
        
        // Scroll to table
        document.getElementById('unit-status-body').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    /* ===================== STATISTIK PERKARA ===================== */

    function renderStatistikPerkara() {
        console.log('\nðŸ“Š Rendering Statistik Perkara...');
        
        const tbody = document.getElementById('statistikPerkaraBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';

        // Daftar kabupaten Jawa Timur
        const kabupatenList = [
            'Surabaya', 'Malang', 'Banyuwangi', 'Jember', 'Sidoarjo', 'Gresik', 
            'Mojokerto', 'Kediri', 'Blitar', 'Probolinggo', 'Pasuruan', 'Tulungagung',
            'Madiun', 'Ponorogo', 'Ngawi', 'Bojonegoro', 'Tuban', 'Lamongan',
            'Pacitan', 'Trenggalek', 'Nganjuk', 'Jombang', 'Bondowoso', 'Situbondo',
            'Lumajang', 'Pamekasan', 'Sampang', 'Sumenep', 'Bangkalan', 'Batu', 'Magetan'
        ];

        kabupatenList.forEach(kabupaten => {
            // Hitung data untuk setiap kategori
            const stats = {
                jaga_budaya: { total: 0, selesai: 0, proses: 0 },
                pengawasan_ormas: { total: 0, selesai: 0, proses: 0 },
                pemantauan_lingkungan: { total: 0, selesai: 0, proses: 0 }
            };

            // Hitung dari CSV data
            ['jaga_budaya', 'pengawasan_ormas', 'pemantauan_lingkungan'].forEach(menuId => {
                const data = CSV_DATA[menuId] || [];
                const kabData = data.filter(row => {
                    let kab = row['Kabupaten/Kota'] || row.Kabupaten || '';
                    if (!kab) {
                        const satker = row['Nama Satker'] || '';
                        for (const k of kabupatenList) {
                            if (satker.toUpperCase().includes(k.toUpperCase())) {
                                kab = k;
                                break;
                            }
                        }
                    }
                    return kab.trim() === kabupaten;
                });

                stats[menuId].total = kabData.length;
                // Simulasi selesai vs proses (70% selesai, 30% proses)
                stats[menuId].selesai = Math.floor(kabData.length * 0.7);
                stats[menuId].proses = kabData.length - stats[menuId].selesai;
            });

            // Skip kabupaten tanpa data
            const hasData = stats.jaga_budaya.total > 0 || 
                           stats.pengawasan_ormas.total > 0 || 
                           stats.pemantauan_lingkungan.total > 0;
            
            if (!hasData) return;

            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition';
            row.innerHTML = `
                <td class="px-4 py-2 text-left font-semibold text-cyan-700 border border-gray-300">${kabupaten}</td>
                <td class="px-3 py-2 text-center text-gray-900 border border-gray-300">${stats.jaga_budaya.total}</td>
                <td class="px-3 py-2 text-center text-emerald-600 border border-gray-300">${stats.jaga_budaya.selesai}</td>
                <td class="px-3 py-2 text-center text-amber-600 border border-gray-300">${stats.jaga_budaya.proses}</td>
                <td class="px-3 py-2 text-center text-gray-900 border border-gray-300">${stats.pengawasan_ormas.total}</td>
                <td class="px-3 py-2 text-center text-emerald-600 border border-gray-300">${stats.pengawasan_ormas.selesai}</td>
                <td class="px-3 py-2 text-center text-amber-600 border border-gray-300">${stats.pengawasan_ormas.proses}</td>
                <td class="px-3 py-2 text-center text-gray-900 border border-gray-300">${stats.pemantauan_lingkungan.total}</td>
                <td class="px-3 py-2 text-center text-emerald-600 border border-gray-300">${stats.pemantauan_lingkungan.selesai}</td>
                <td class="px-3 py-2 text-center text-amber-600 border border-gray-300">${stats.pemantauan_lingkungan.proses}</td>
            `;
            tbody.appendChild(row);
        });

        console.log('âœ… Statistik Perkara rendered');
    }

        if (hasLucide) lucide.createIcons();
    

    /* ===================== CHART BAR UTAMA ===================== */

    function initPerformanceBarChart(data) {
        if (performanceBarChartInstance) {
            performanceBarChartInstance.destroy();
        }

        const container = document.getElementById('performanceBarChartContainer');
        let canvas = document.getElementById('performanceBarChart');
        
        // Pastikan canvas ada di container
        if (!canvas) {
            container.innerHTML = '<canvas id="performanceBarChart"></canvas>';
            canvas = document.getElementById('performanceBarChart');
        }
        
        const ctx = canvas.getContext('2d');

        // Ambil data CSV untuk menu aktif
        const csvData = CSV_DATA[currentMenuId] || [];
        
        if (csvData.length === 0) {
            console.warn(`âš ï¸ Tidak ada CSV data untuk chart menu: ${currentMenuId}`);
            container.innerHTML = `
                <canvas id="performanceBarChart" style="display:none;"></canvas>
                <div class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-cyan-400 mx-auto mb-4"></div>
                    <p class="text-gray-400 text-sm">Memuat data chart...</p>
                </div>
            `;
            return;
        }
        
        console.log(`âœ… Chart rendering with ${csvData.length} rows for menu: ${currentMenuId}`);

        // Hitung data per kabupaten dari CSV
        const kabupatenList = [
            'Surabaya', 'Malang', 'Banyuwangi', 'Jember', 'Sidoarjo', 'Gresik', 
            'Mojokerto', 'Kediri', 'Blitar', 'Probolinggo', 'Pasuruan', 'Tulungagung',
            'Madiun', 'Ponorogo', 'Ngawi', 'Bojonegoro', 'Tuban', 'Lamongan',
            'Pacitan', 'Trenggalek', 'Nganjuk', 'Jombang', 'Bondowoso', 'Situbondo',
            'Lumajang', 'Pamekasan', 'Sampang', 'Sumenep', 'Bangkalan', 'Batu', 'Magetan'
        ];

        const kabupatenCounts = {};
        
        csvData.forEach(row => {
            let kabupaten = row['Kabupaten/Kota'] || row.Kabupaten || '';
            
            if (!kabupaten) {
                const satker = row['Nama Satker'] || '';
                for (const kab of kabupatenList) {
                    if (satker.toUpperCase().includes(kab.toUpperCase())) {
                        kabupaten = kab;
                        break;
                    }
                }
            }
            
            if (kabupaten && kabupaten !== 'UNKNOWN') {
                kabupaten = kabupaten.trim();
                kabupatenCounts[kabupaten] = (kabupatenCounts[kabupaten] || 0) + 1;
            }
        });

        // Sort dan ambil top 15
        const sortedKabupaten = Object.entries(kabupatenCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 15);

        if (sortedKabupaten.length === 0) {
            container.innerHTML = `
                <canvas id="performanceBarChart" style="display:none;"></canvas>
                <div class="text-center py-8 text-gray-400">Tidak ada data kabupaten untuk ditampilkan</div>
            `;
            return;
        }

        const labels = sortedKabupaten.map(([kab]) => kab);
        const dataValues = sortedKabupaten.map(([, count]) => count);

        // Set tinggi container dinamis
        const minHeight = 400;
        const calculatedHeight = Math.max(minHeight, sortedKabupaten.length * 35);
        container.style.height = calculatedHeight + 'px';

        // Buat gradient untuk line
        const gradient = ctx.createLinearGradient(0, 0, 0, calculatedHeight);
        gradient.addColorStop(0, 'rgba(34, 211, 238, 0.4)');
        gradient.addColorStop(1, 'rgba(34, 211, 238, 0.05)');

        performanceBarChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Jumlah Data',
                    data: dataValues,
                    borderColor: '#22D3EE',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#22D3EE',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointHoverBackgroundColor: '#06B6D4',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 800,
                    easing: 'easeInOutQuart'
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { 
                            color: '#E5E7EB',
                            padding: 15,
                            font: {
                                size: 13,
                                weight: 'bold'
                            },
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#22D3EE',
                        bodyColor: '#fff',
                        borderColor: '#22D3EE',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: false,
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return 'Total: ' + context.parsed.y.toLocaleString('id-ID') + ' data';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { 
                            color: '#E5E7EB',
                            font: { size: 11 },
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: { 
                            color: 'rgba(148,163,184,0.1)',
                            display: true
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { 
                            color: '#E5E7EB',
                            font: { size: 11 },
                            callback: function(value) {
                                return value.toLocaleString('id-ID');
                            }
                        },
                        grid: { 
                            color: 'rgba(148,163,184,0.15)',
                            display: true
                        }
                    }
                },
                interaction: {
                    intersect: false,
                    mode: 'index'
                }
            }
        });
    }


    /* ===================== FILTER & MENU ===================== */

    function populateUnitFilter(names) {
        const select = document.getElementById('filter-unit');
        const sorted = [...names].sort();
        sorted.forEach(name => {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            select.appendChild(opt);
        });
    }

    function getFilteredData() {
        const unitValue = document.getElementById('filter-unit').value;
        let base = MENU_DATA[currentMenuId];

        if (unitValue) {
            base = base.filter(u => u.name === unitValue);
        } else if (currentStatusFilter === 'compliant') {
            base = base.filter(u => u.actual >= u.target);
        } else if (currentStatusFilter === 'pending') {
            base = base.filter(u => u.actual < u.target);
        }

        return base;
    }

    function applyFilter() {
        const filterDate = document.getElementById('filter-date').value;
        const displayDate = filterDate ? new Date(filterDate) : new Date();
        document.getElementById('current-date').textContent = formatDateLong(displayDate);

        currentData = getFilteredData();

        renderSummary();
        renderTable(currentData);
        initPerformanceBarChart(currentData);
    }

    function resetFilter() {
        const today = new Date();
        const todayISO = today.toISOString().split('T')[0];

        const dateInput = document.getElementById('filter-date');
        if (dateInput) dateInput.value = todayISO;

        const unitSelect = document.getElementById('filter-unit');
        if (unitSelect) unitSelect.value = '';

        currentStatusFilter = 'all';
        currentData = [...MENU_DATA[currentMenuId]];
        document.getElementById('current-date').textContent = formatDateLong(today);

        renderSummary();
        renderTable(currentData);
        initPerformanceBarChart(currentData);
    }

    function renderMainMenu() {
        const container = document.getElementById('main-menu-container');
        if (!container) return;
        container.innerHTML = '';

        MAIN_MENUS.forEach(menu => {
            const isActive = menu.id === currentMenuId;
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = [
                'w-full text-left px-3 py-3 rounded-2xl flex items-start gap-3 transition border',
                isActive
                    ? 'bg-sky-100 border-sky-400 shadow-lg'
                    : 'bg-white/90 border-gray-200 hover:bg-gray-100'
            ].join(' ');

            btn.innerHTML = `
                <span class="mt-1">
                    <i data-lucide="${menu.icon}" class="w-5 h-5 text-sky-600"></i>
                </span>
                <span class="flex-1">
                    <span class="block text-sm font-semibold text-gray-800">${menu.title}</span>
                    ${menu.subtitle
                        ? `<span class="block text-xs text-gray-600">${menu.subtitle}</span>`
                        : ''}
                </span>
            `;

            btn.addEventListener('click', () => {
                currentMenuId = menu.id;
                currentStatusFilter = 'all';
                document.getElementById('active-menu-label').textContent = getMenuLabel(currentMenuId);
                resetFilter();
                renderMainMenu();
                // Update top stats visibility
                updateTopStatsVisibility();
                // Update disparitas dan map
                updateDisparitasChart();
                updateMap();
                // Update line chart
                initPerformanceBarChart();
            });

            container.appendChild(btn);
        });

        if (hasLucide) lucide.createIcons();
    }

    /* ===================== MODAL: DAFTAR SEMUA SATKER + GRAFIK ===================== */

    function showUnitListModal() {
        const modal = document.getElementById('unit-list-modal');
        const content = document.getElementById('unit-list-content');
        content.innerHTML = '';

        const units = [...MENU_DATA[currentMenuId]].sort((a, b) => a.name.localeCompare(b.name));

        units.forEach(unit => {
            const item = document.createElement('button');
            item.type = 'button';
            item.className =
                'w-full text-left text-sm text-gray-800 p-2 bg-gray-50 rounded-xl hover:bg-sky-100 hover:text-sky-800 transition border border-gray-200 flex justify-between items-center';
            item.innerHTML = `
                <span>${unit.name}</span>
                <span class="text-xs text-sky-600 flex items-center gap-1">
                    Lihat Grafik
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                </span>
            `;
            item.addEventListener('click', () => {
                showSatkerChart(unit.name);
            });
            content.appendChild(item);
        });

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        if (hasLucide) lucide.createIcons();
    }

    function hideUnitListModal() {
        const modal = document.getElementById('unit-list-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    function showSatkerChart(unitName) {
        const modal = document.getElementById('satker-chart-modal');
        const titleEl = document.getElementById('satker-chart-title');
        const missingEl = document.getElementById('satker-missing-days');
        const canvas = document.getElementById('satkerHistoryChart');
        const ctx = canvas.getContext('2d');

        const unit = MENU_DATA[currentMenuId].find(u => u.name === unitName);
        if (!unit || !unit.history) {
            missingEl.textContent = 'Data tidak tersedia untuk satker ini.';
            return;
        }

        const historySorted = [...unit.history].sort((a, b) => new Date(a.date) - new Date(b.date));

        const labels = [];
        const actualData = [];
        const targetData = [];
        const missingDays = [];

        historySorted.forEach(h => {
            const dateObj = new Date(h.date);
            const labelFull = dateObj.toLocaleDateString('id-ID', { weekday: 'short', day: '2-digit', month: '2-digit' });

            if (h.actual && h.actual > 0) {
                labels.push(labelFull);
                actualData.push(h.actual);
                targetData.push(h.target);
            } else {
                missingDays.push(labelFull);
            }
        });

        canvas.height = 260;

        if (satkerHistoryChartInstance) {
            satkerHistoryChartInstance.destroy();
        }

        satkerHistoryChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Input Aktual',
                        data: actualData,
                        backgroundColor: '#0EA5E9',
                        borderRadius: 4
                    },
                    {
                        label: 'Target Harian',
                        data: targetData,
                        backgroundColor: '#4F46E5',
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: {
                    legend: { position: 'top', labels: { color: '#E5E7EB' } },
                },
                scales: {
                    x: { ticks: { maxRotation: 60, minRotation: 40, color: '#E5E7EB' }, grid: { color: 'rgba(148,163,184,0.25)' } },
                    y: { beginAtZero: true, ticks: { color: '#E5E7EB' }, grid: { color: 'rgba(148,163,184,0.25)' } }
                }
            }
        });

        if (missingDays.length > 0) {
            missingEl.innerHTML = `
                <span class="font-semibold">Hari tanpa input (0 laporan) dalam 20 hari terakhir:</span>
                <br>${missingDays.join(', ')}
            `;
        } else {
            missingEl.innerHTML = `
                <span class="font-semibold text-emerald-300">Satker ini menyelesaikan input pada semua 20 hari terakhir.</span>
            `;
        }

        titleEl.textContent = `Kinerja 20 Hari Terakhir - ${unitName}`;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    }

    function hideSatkerChartModal() {
        const modal = document.getElementById('satker-chart-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    /* ===================== MODAL: SATKER SELESAI / PENDING ===================== */

    function showSatkerStatusModal(type) {
        const modal = document.getElementById('satker-modal');
        const titleEl = document.getElementById('satker-modal-title');
        const listContainer = document.getElementById('satker-list-container');

        let filteredData = [];
        let titleText = '';
        let statusBadgeClass = '';

        if (type === 'compliant') {
            filteredData = MENU_DATA[currentMenuId].filter(u => u.actual >= u.target);
            titleText = 'Daftar Satuan Kerja Selesai Input Hari Ini';
            statusBadgeClass = 'badge-emerald';
        } else {
            filteredData = MENU_DATA[currentMenuId].filter(u => u.actual < u.target);
            titleText = 'Daftar Satuan Kerja Belum Selesai Input';
            statusBadgeClass = 'badge-amber';
        }

        titleEl.textContent = titleText;
        listContainer.innerHTML = '';

        if (filteredData.length === 0) {
            listContainer.innerHTML = '<p class="text-center text-gray-300 py-4">Tidak ada Satker dalam kategori ini.</p>';
        } else {
            filteredData.forEach(unit => {
                const selesai = unit.actual >= unit.target;
                const statusText = selesai ? 'Selesai' : 'Belum Selesai';
                const jam = unit.lastInputTime || 'Belum Input';

                const wrapper = document.createElement('button');
                wrapper.type = 'button';
                wrapper.className =
                    'w-full flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-200 cursor-pointer hover:bg-gray-100';

                wrapper.innerHTML = `
                    <div class="flex flex-col text-left">
                        <span class="font-semibold text-gray-800 underline">${unit.name}</span>
                        <span class="text-xs text-gray-600">Waktu Input: ${jam}</span>
                    </div>
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${statusBadgeClass}">
                        ${statusText}
                    </span>
                `;
                wrapper.addEventListener('click', () => {
                    showDetailKegiatan(unit.name);
                });
                listContainer.appendChild(wrapper);
            });
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');
        if (hasLucide) lucide.createIcons();
    }

    function hideSatkerStatusModal() {
        const modal = document.getElementById('satker-modal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    /* ===================== MODAL: DETAIL KEGIATAN ===================== */

	function showDetailKegiatan(unitName) {
		const modal = document.getElementById("detail-kegiatan-modal");
		const title = document.getElementById("detail-kegiatan-title");
		const content = document.getElementById("detail-kegiatan-content");

		title.textContent = `Detail Kegiatan - ${unitName}`;
		content.innerHTML = "";

		const kegiatanList = MOCK_KEGIATAN[unitName] || [];

		if (kegiatanList.length === 0) {
			content.innerHTML =
				`<p class="text-center text-gray-600 py-4">Belum ada data kegiatan untuk unit ini.</p>`;
		} else {
			kegiatanList.forEach(k => {
				content.innerHTML += `
					<div class="border border-gray-200 rounded-2xl p-4 shadow-sm bg-gray-50">
						<h4 class="text-lg font-semibold text-gray-900">${k.nama}</h4>
						<p class="text-sm text-gray-700 mt-1">
							<b>Mulai:</b> ${k.waktu_mulai} WIB<br>
							<b>Selesai:</b> ${k.waktu_selesai} WIB
						</p>
						${k.deskripsi ? `
							<p class="text-sm text-gray-600 mt-2">
								${k.deskripsi}
							</p>
						` : ""}
						${k.dokumentasi ? `
							<img src="${k.dokumentasi}" class="w-full rounded-xl mt-3 shadow" alt="Dokumentasi kegiatan">
						` : ""}
					</div>
				`;
			});
		}

		modal.classList.remove("hidden");
		modal.classList.add("flex");
	}


    function hideDetailKegiatan() {
        const modal = document.getElementById("detail-kegiatan-modal");
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }

    /* ===================== TOP STATS CARDS ===================== */

    // Simpan data CSV untuk setiap menu
    const CSV_DATA = {
        'jaksa_garda': [],  // Added for consistency
        'jaga_budaya': [],
        'pengawasan_ormas': [],
        'pemantauan_lingkungan': [],
        'pemantauan_orang_asing': [],
        'aset_desa': [],
        'kasus_penyelewengan': []
    };

    // Fungsi untuk parsing CSV - improved version
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length === 0) return [];
        
        const headers = lines[0].split(',').map(h => h.trim());
        const data = [];
        
        console.log('  ðŸ“‹ CSV Headers:', headers);
        
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue; // Skip empty lines
            
            const values = line.split(',');
            if (values.length >= headers.length) {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = values[index] ? values[index].trim() : '';
                });
                data.push(obj);
            }
        }
        
        console.log(`  âœ“ Parsed ${data.length} rows`);
        if (data.length > 0) {
            console.log('  Sample:', data[0]);
        }
        
        return data;
    }

    // Fungsi untuk load CSV file
    async function loadCSVData(menuId, fileName) {
        try {
            console.log(`\nðŸ“‚ Loading ${fileName} for menu ${menuId}...`);
            const response = await fetch(fileName);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const csvText = await response.text();
            console.log(`  âœ“ Fetched ${csvText.length} characters`);
            
            CSV_DATA[menuId] = parseCSV(csvText);
            console.log(`âœ… ${menuId}: ${CSV_DATA[menuId].length} rows loaded\n`);
            
            return CSV_DATA[menuId].length;
        } catch (error) {
            console.error(`âŒ Error loading ${fileName}:`, error);
            CSV_DATA[menuId] = [];
            return 0;
        }
    }

    async function renderTopStatsCards() {
        console.log('\nðŸŽ¨ === RENDERING TOP STATS CARDS ===\n');
        
        const menuConfig = [
            { id: 'jaga_budaya', label: 'Jaga Budaya', chartId: 'chartJagaBudaya', totalId: 'totalJagaBudaya', breakdownId: 'breakdownJagaBudaya', color: 'rgba(103, 232, 249, 1)', csvFile: 'jaga_budaya.csv' },
            { id: 'pengawasan_ormas', label: 'Pengawasan Ormas', chartId: 'chartPengawasanOrmas', totalId: 'totalPengawasanOrmas', breakdownId: 'breakdownPengawasanOrmas', color: 'rgba(192, 132, 252, 1)', csvFile: 'pengawasan_ormas.csv' },
            { id: 'pemantauan_lingkungan', label: 'Pemantauan Lingkungan', chartId: 'chartPemantauanLingkungan', totalId: 'totalPemantauanLingkungan', breakdownId: 'breakdownPemantauanLingkungan', color: 'rgba(52, 211, 153, 1)', csvFile: 'pemantauan_lingkungan.csv' },
            { id: 'pemantauan_orang_asing', label: 'Pemantauan Orang Asing', chartId: 'chartPemantauanOrangAsing', totalId: 'totalPemantauanOrangAsing', breakdownId: 'breakdownPemantauanOrangAsing', color: 'rgba(250, 204, 21, 1)', csvFile: 'pemantauan_orang_asing.csv' },
            { id: 'aset_desa', label: 'Aset Desa/Kelurahan', chartId: 'chartAsetDesa', totalId: 'totalAsetDesa', breakdownId: 'breakdownAsetDesa', color: 'rgba(96, 165, 250, 1)', csvFile: 'aset_desa.csv' },
            { id: 'kasus_penyelewengan', label: 'Kasus Penyelewengan', chartId: 'chartKasusPenyelewengan', totalId: 'totalKasusPenyelewengan', breakdownId: 'breakdownKasusPenyelewengan', color: 'rgba(248, 113, 113, 1)', csvFile: 'kasus_penyelewengan.csv' }
        ];

        for (const menu of menuConfig) {
            // Load CSV data
            const total = await loadCSVData(menu.id, menu.csvFile);
            
            // Simulasi compliant dan pending (bisa disesuaikan dengan logika bisnis Anda)
            const compliant = Math.floor(total * 0.7); // 70% selesai
            const pending = total - compliant;

            // Update total
            const totalEl = document.getElementById(menu.totalId);
            if (totalEl) totalEl.textContent = total.toLocaleString('id-ID');

            // Update breakdown
            const breakdownEl = document.getElementById(menu.breakdownId);
            if (breakdownEl) {
                breakdownEl.innerHTML = `
                    <span class="text-emerald-400">âœ“ ${compliant.toLocaleString('id-ID')} Selesai</span> Â· 
                    <span class="text-amber-400">â³ ${pending.toLocaleString('id-ID')} Pending</span>
                `;
            }

            // Create mini donut chart
            const canvas = document.getElementById(menu.chartId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [compliant, pending],
                            backgroundColor: [menu.color, 'rgba(255, 255, 255, 0.15)'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false }
                        }
                    }
                });  
            }
        }

        // Update disparitas dan map setelah semua CSV selesai load
        console.log('\nðŸ“Š All CSV files loaded!');
        console.log('CSV_DATA summary:', Object.keys(CSV_DATA).map(key => `  ${key}: ${CSV_DATA[key].length} rows`).join('\n'));
        console.log('\nâ° Scheduling chart and map updates in 500ms...\n');
        
        setTimeout(() => {
            console.log('ðŸ”„ NOW triggering chart and map updates...\n');
            updateTopStatsVisibility();  // Update visibility of top stats cards
            updateDisparitasChart();
            updateMap();
            initPerformanceBarChart();  // Init line chart setelah CSV loaded
            renderStatistikPerkara();  // Render statistik perkara
        }, 500);
    }

    /* ===================== UPDATE TOP STATS VISIBILITY ===================== */
    
    function updateTopStatsVisibility() {
        console.log(`\nðŸŽ¯ Updating top stats visibility for menu: ${currentMenuId}`);
        
        const allCards = document.querySelectorAll('.top-stat-card');
        const container = document.getElementById('topStatsContainer');
        
        // Skip jaksa_garda as it has no CSV data
        if (currentMenuId === 'jaksa_garda') {
            console.log('  âš ï¸  Jaksa Garda menu - hiding all stats cards');
            allCards.forEach(card => card.classList.add('hidden'));
            return;
        }
        
        // Hide all cards first
        allCards.forEach(card => {
            card.classList.add('hidden');
        });
        
        // Show only the card for current menu
        const activeCard = document.querySelector(`[data-menu-id="${currentMenuId}"]`);
        if (activeCard) {
            activeCard.classList.remove('hidden');
            console.log(`  âœ… Showing card for: ${currentMenuId}`);
        } else {
            console.log(`  âš ï¸  No card found for menu: ${currentMenuId}`);
        }
        
        // Adjust grid layout based on visible cards
        const visibleCount = document.querySelectorAll('.top-stat-card:not(.hidden)').length;
        if (visibleCount === 1) {
            container.className = 'grid grid-cols-1 gap-5 mb-8';
        } else if (visibleCount <= 3) {
            container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mb-8';
        } else {
            container.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5 mb-8';
        }
    }

    /* ===================== INIT ===================== */

    document.addEventListener('DOMContentLoaded', () => {
        const today = new Date();
        const todayISO = today.toISOString().split('T')[0];

        const dateInput = document.getElementById('filter-date');
        if (dateInput) dateInput.value = todayISO;

        document.getElementById('current-date').textContent = formatDateLong(today);
        document.getElementById('active-menu-label').textContent = getMenuLabel(currentMenuId);

        populateUnitFilter(SATUAN_KERJA_NAMES);

        currentData = [...MENU_DATA[currentMenuId]];
        renderMainMenu();
        renderSummary();
        renderTable(currentData);
        renderTopStatsCards();

        // tombol filter
        document.getElementById('apply-filter-btn').addEventListener('click', applyFilter);
        document.getElementById('reset-filter-btn').addEventListener('click', resetFilter);
        document.getElementById('print-btn').addEventListener('click', () => window.print());

        // summary cards
        document.getElementById('total-units-card').addEventListener('click', () => {
            currentStatusFilter = 'all';
            applyFilter();
            showUnitListModal();
        });

        document.getElementById('compliant-card').addEventListener('click', () => {
            currentStatusFilter = 'compliant';
            applyFilter();
            showSatkerStatusModal('compliant');
        });

        document.getElementById('pending-card').addEventListener('click', () => {
            currentStatusFilter = 'pending';
            applyFilter();
            showSatkerStatusModal('pending');
        });

        // close modals (klik tombol X)
        document.getElementById('close-modal-btn').addEventListener('click', hideUnitListModal);
        document.getElementById('close-satker-modal-btn').addEventListener('click', hideSatkerStatusModal);
        document.getElementById('close-satker-chart-modal-btn').addEventListener('click', hideSatkerChartModal);

        // close modals (klik area gelap)
        document.getElementById('unit-list-modal').addEventListener('click', e => {
            if (e.target.id === 'unit-list-modal') hideUnitListModal();
        });
        document.getElementById('satker-modal').addEventListener('click', e => {
            if (e.target.id === 'satker-modal') hideSatkerStatusModal();
        });
        document.getElementById('detail-kegiatan-modal').addEventListener('click', e => {
            if (e.target.id === 'detail-kegiatan-modal') hideDetailKegiatan();
        });
        document.getElementById('satker-chart-modal').addEventListener('click', e => {
            if (e.target.id === 'satker-chart-modal') hideSatkerChartModal();
        });

        // Init Disparitas Chart dan Map
        initDisparitasChart();
        initMap();
        
        // Start auto-rotation after everything is loaded
        setTimeout(() => {
            startAutoRotation();
        }, 3000);  // Start after 3 seconds
    });

    /* ===================== AUTO ROTATION ===================== */
    
    function startAutoRotation() {
        console.log('\nðŸ”„ Starting auto-rotation every 5 seconds...');
        
        // Daftar menu yang punya CSV data (skip jaksa_garda)
        const menuWithData = ['jaga_budaya', 'pengawasan_ormas', 'pemantauan_lingkungan', 
                              'pemantauan_orang_asing', 'aset_desa', 'kasus_penyelewengan'];
        
        let currentIndex = menuWithData.indexOf(currentMenuId);
        if (currentIndex === -1) currentIndex = 0;
        
        let countdown = 5;
        
        // Update countdown timer setiap detik
        const countdownInterval = setInterval(() => {
            countdown--;
            const timerEl = document.getElementById('rotationTimer');
            if (timerEl) {
                timerEl.textContent = countdown + 's';
            }
            if (countdown <= 0) {
                countdown = 5;
            }
        }, 1000);
        
        autoRotateInterval = setInterval(() => {
            // Move to next menu
            currentIndex = (currentIndex + 1) % menuWithData.length;
            const nextMenuId = menuWithData[currentIndex];
            
            console.log(`\nâ© Auto-rotating from ${currentMenuId} to: ${nextMenuId}`);
            
            // Update current menu
            currentMenuId = nextMenuId;
            currentStatusFilter = 'all';
            
            // Update label
            const labelEl = document.getElementById('active-menu-label');
            if (labelEl) {
                labelEl.textContent = getMenuLabel(currentMenuId);
            }
            
            // Refresh main menu UI
            renderMainMenu();
            
            // Update top stats visibility
            console.log(`  ðŸŽ¯ Updating top stats for ${currentMenuId}...`);
            updateTopStatsVisibility();
            
            // Update chart and map with smooth transition
            console.log(`  ðŸ“Š Updating chart for ${currentMenuId}...`);
            updateDisparitasChart();
            console.log(`  ðŸ—ºï¸  Updating map for ${currentMenuId}...`);
            updateMap();
            console.log(`  ðŸ“ˆ Updating line chart for ${currentMenuId}...`);
            initPerformanceBarChart();
            
            // Reset countdown
            countdown = 5;
            
        }, 5000);  // Every 5 seconds
        
        // Store countdown interval reference
        autoRotateInterval.countdown = countdownInterval;
    }
    
    function stopAutoRotation() {
        if (autoRotateInterval) {
            clearInterval(autoRotateInterval);
            if (autoRotateInterval.countdown) {
                clearInterval(autoRotateInterval.countdown);
            }
            autoRotateInterval = null;
            console.log('Auto-rotation stopped');
        }
    }

    /* ===================== DISPARITAS CHART ===================== */
    
    let disparitasChartInstance = null;

    async function initDisparitasChart() {
        console.log('\nðŸ“ˆ === INIT DISPARITAS CHART ===');
        
        // Tunggu sampai CSV_DATA siap - delay lebih lama
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        console.log('  Current menu ID:', currentMenuId);
        console.log('  CSV_DATA keys:', Object.keys(CSV_DATA));
        console.log('  Data for current menu:', CSV_DATA[currentMenuId] ? CSV_DATA[currentMenuId].length + ' rows' : 'NOT LOADED');
        
        if (!CSV_DATA[currentMenuId] || CSV_DATA[currentMenuId].length === 0) {
            console.error('  âš ï¸ WARNING: CSV_DATA not ready for', currentMenuId);
        }
        
        updateDisparitasChart();
    }

    function updateDisparitasChart() {
        console.log('=== UPDATE CHART ===');
        console.log('Menu aktif:', currentMenuId);
        
        // Add transition animation
        const section = document.getElementById('disparitas-section');
        if (section) {
            section.classList.remove('chart-transition');
            void section.offsetWidth; // Trigger reflow
            section.classList.add('chart-transition');
        }
        
        // Hitung jumlah data per kabupaten untuk menu yang aktif
        const kabupatenCounts = {};
        
        // Ambil data dari menu yang sedang aktif
        const menuData = CSV_DATA[currentMenuId] || [];
        
        console.log('Jumlah data untuk menu ' + currentMenuId + ':', menuData.length);
        
        if (menuData.length === 0) {
            console.warn('âš ï¸ Tidak ada data untuk menu:', currentMenuId);
            return;
        }
        
        // Log sample data untuk debug
        if (menuData[0]) {
            console.log('Sample row:', menuData[0]);
            console.log('Available columns:', Object.keys(menuData[0]));
        }
        
        // Daftar kabupaten Jawa Timur untuk matching
        const kabupatenList = [
            'Surabaya', 'Malang', 'Banyuwangi', 'Jember', 'Sidoarjo', 'Gresik', 
            'Mojokerto', 'Kediri', 'Blitar', 'Probolinggo', 'Pasuruan', 'Tulungagung',
            'Madiun', 'Ponorogo', 'Ngawi', 'Bojonegoro', 'Tuban', 'Lamongan',
            'Pacitan', 'Trenggalek', 'Nganjuk', 'Jombang', 'Bondowoso', 'Situbondo',
            'Lumajang', 'Pamekasan', 'Sampang', 'Sumenep', 'Bangkalan', 'Batu', 'Magetan'
        ];
        
        menuData.forEach(row => {
            // Try to get kabupaten from different possible columns
            let kabupaten = row['Kabupaten/Kota'] || row.Kabupaten || '';
            
            // Jika tidak ada kolom kabupaten, coba extract dari Nama Satker atau Desa
            if (!kabupaten) {
                const satker = row['Nama Satker'] || '';
                const desa = row['Desa / Kelurahan'] || row['Desa/Kelurahan'] || '';
                
                // Try to match kabupaten from satker name (e.g., "KEJAKSAAN NEGERI MALANG")
                for (const kab of kabupatenList) {
                    if (satker.toUpperCase().includes(kab.toUpperCase())) {
                        kabupaten = kab;
                        break;
                    }
                }
                
                // If still not found, try from desa name
                if (!kabupaten) {
                    for (const kab of kabupatenList) {
                        if (desa.toUpperCase().includes(kab.toUpperCase())) {
                            kabupaten = kab;
                            break;
                        }
                    }
                }
            }
            
            if (kabupaten && kabupaten !== 'UNKNOWN') {
                kabupaten = kabupaten.trim();
                if (!kabupatenCounts[kabupaten]) {
                    kabupatenCounts[kabupaten] = 0;
                }
                kabupatenCounts[kabupaten]++;
            }
        });

        console.log('Kabupaten yang ditemukan:', Object.keys(kabupatenCounts).length);

        // Sort by count
        const sortedKabupaten = Object.entries(kabupatenCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10); // Top 10

        if (sortedKabupaten.length === 0) {
            console.error('âŒ Tidak ada data kabupaten');
            return;
        }

        console.log('Top 10 kabupaten:', sortedKabupaten);

        const labels = sortedKabupaten.map(([kab]) => {
            // Singkat nama kabupaten
            return kab.length > 15 ? kab.substring(0, 15) + '...' : kab;
        });

        const counts = sortedKabupaten.map(([, count]) => count);

        // Update info
        const [topKab, topCount] = sortedKabupaten[0];
        const [lowKab, lowCount] = sortedKabupaten[sortedKabupaten.length - 1];
        
        const currentSatkerEl = document.getElementById('currentSatker');
        const kasusTertinggiEl = document.getElementById('kasusTertinggi');
        const kasusTerendahEl = document.getElementById('kasusTerendah');
        
        if (currentSatkerEl) currentSatkerEl.textContent = topKab;
        if (kasusTertinggiEl) kasusTertinggiEl.textContent = `${topCount.toLocaleString('id-ID')} Data`;
        if (kasusTerendahEl) kasusTerendahEl.textContent = `${lowCount.toLocaleString('id-ID')} Data`;

        // Create chart
        const canvas = document.getElementById('disparitasChart');
        if (!canvas) {
            console.error('âŒ Canvas element tidak ditemukan!');
            return;
        }
        
        console.log('âœ“ Canvas ditemukan, membuat chart...');
        const ctx = canvas.getContext('2d');
        
        if (disparitasChartInstance) {
            console.log('Menghapus chart lama...');
            disparitasChartInstance.destroy();
        }

        disparitasChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Jumlah Data',
                    data: counts,
                    backgroundColor: 'rgba(34, 211, 238, 0.8)',
                    borderColor: 'rgba(34, 211, 238, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return 'Jumlah: ' + context.parsed.y + ' data';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { 
                            color: '#E5E7EB',
                            font: { size: 10 }
                        },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#E5E7EB' },
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    }
                }
            }
        });
        
        console.log('âœ… Chart berhasil dibuat!');
    }

    /* ===================== MAP LEAFLET ===================== */
    
    let mapInstance = null;
    let markersLayer = null;

    async function initMap() {
        console.log('\nðŸ—ºï¸  === INIT MAP ===');
        
        // Inisialisasi Leaflet Map - fokus ke Jawa Timur
        mapInstance = L.map('mapLeaflet').setView([-7.5, 112.5], 8);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors',
            maxZoom: 18
        }).addTo(mapInstance);

        markersLayer = L.layerGroup().addTo(mapInstance);

        // Tunggu data CSV siap
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        console.log('  Current menu ID for map:', currentMenuId);
        console.log('  Data for map:', CSV_DATA[currentMenuId] ? CSV_DATA[currentMenuId].length + ' rows' : 'NOT LOADED');
        
        if (!CSV_DATA[currentMenuId] || CSV_DATA[currentMenuId].length === 0) {
            console.error('  âš ï¸ WARNING: CSV_DATA not ready for map', currentMenuId);
        }
        
        console.log('  Updating map markers...');
        updateMap();
    }

    function updateMap() {
        console.log('=== UPDATE MAP ===');
        console.log('Menu aktif:', currentMenuId);
        
        if (!markersLayer || !mapInstance) {
            console.error('âŒ Map belum diinisialisasi!');
            return;
        }
        
        // Hapus markers lama
        markersLayer.clearLayers();

        // Data koordinat kabupaten/kota di Jawa Timur
        const kabupatenLocations = {
            'Surabaya': { lat: -7.2575, lng: 112.7521 },
            'Malang': { lat: -7.9666, lng: 112.6326 },
            'Banyuwangi': { lat: -8.2192, lng: 114.3691 },
            'Jember': { lat: -8.1665, lng: 113.7009 },
            'Sidoarjo': { lat: -7.4470, lng: 112.7183 },
            'Gresik': { lat: -7.1554, lng: 112.6560 },
            'Mojokerto': { lat: -7.4664, lng: 112.4338 },
            'Kediri': { lat: -7.8167, lng: 112.0167 },
            'Blitar': { lat: -8.0983, lng: 112.1681 },
            'Probolinggo': { lat: -7.7543, lng: 113.2159 },
            'Pasuruan': { lat: -7.6453, lng: 112.9075 },
            'Tulungagung': { lat: -8.0658, lng: 111.9028 },
            'Madiun': { lat: -7.6298, lng: 111.5239 },
            'Ponorogo': { lat: -7.8698, lng: 111.4618 },
            'Ngawi': { lat: -7.4038, lng: 111.4462 },
            'Bojonegoro': { lat: -7.1502, lng: 111.8817 },
            'Tuban': { lat: -6.8978, lng: 111.9628 },
            'Lamongan': { lat: -7.1165, lng: 112.4169 },
            'Pacitan': { lat: -8.1988, lng: 111.0918 },
            'Trenggalek': { lat: -8.0502, lng: 111.7088 },
            'Nganjuk': { lat: -7.6051, lng: 111.9037 },
            'Jombang': { lat: -7.5446, lng: 112.2331 },
            'Bondowoso': { lat: -7.9136, lng: 113.8207 },
            'Situbondo': { lat: -7.7063, lng: 114.0095 },
            'Lumajang': { lat: -8.1335, lng: 113.2248 },
            'Pamekasan': { lat: -7.1568, lng: 113.4746 },
            'Sampang': { lat: -7.1847, lng: 113.2391 },
            'Sumenep': { lat: -7.0176, lng: 113.8549 },
            'Bangkalan': { lat: -7.0455, lng: 112.7519 },
            'Batu': { lat: -7.8705, lng: 112.5281 },
            'Magetan': { lat: -7.6417, lng: 111.3403 }
        };

        // Hitung data per kabupaten untuk menu aktif
        const kabupatenStats = {};
        const menuData = CSV_DATA[currentMenuId] || [];
        
        console.log('Data untuk map:', menuData.length, 'rows');
        
        if (menuData.length === 0) {
            console.warn('âš ï¸ Tidak ada data untuk map menu:', currentMenuId);
            return;
        }
        
        // Log sample untuk debug
        if (menuData[0]) {
            console.log('Sample row untuk map:', menuData[0]);
        }
        
        // Daftar kabupaten Jawa Timur untuk matching
        const kabupatenList = [
            'Surabaya', 'Malang', 'Banyuwangi', 'Jember', 'Sidoarjo', 'Gresik', 
            'Mojokerto', 'Kediri', 'Blitar', 'Probolinggo', 'Pasuruan', 'Tulungagung',
            'Madiun', 'Ponorogo', 'Ngawi', 'Bojonegoro', 'Tuban', 'Lamongan',
            'Pacitan', 'Trenggalek', 'Nganjuk', 'Jombang', 'Bondowoso', 'Situbondo',
            'Lumajang', 'Pamekasan', 'Sampang', 'Sumenep', 'Bangkalan', 'Batu', 'Magetan'
        ];
        
        menuData.forEach(row => {
            // Try to get kabupaten from different possible columns
            let kabupaten = row['Kabupaten/Kota'] || row.Kabupaten || '';
            
            // Jika tidak ada kolom kabupaten, coba extract dari Nama Satker atau Desa
            if (!kabupaten) {
                const satker = row['Nama Satker'] || '';
                const desa = row['Desa / Kelurahan'] || row['Desa/Kelurahan'] || '';
                
                // Try to match kabupaten from satker name (e.g., "KEJAKSAAN NEGERI MALANG")
                for (const kab of kabupatenList) {
                    if (satker.toUpperCase().includes(kab.toUpperCase())) {
                        kabupaten = kab;
                        break;
                    }
                }
                
                // If still not found, try from desa name
                if (!kabupaten) {
                    for (const kab of kabupatenList) {
                        if (desa.toUpperCase().includes(kab.toUpperCase())) {
                            kabupaten = kab;
                            break;
                        }
                    }
                }
            }
            
            if (kabupaten && kabupaten !== 'UNKNOWN') {
                kabupaten = kabupaten.trim();
                if (!kabupatenStats[kabupaten]) {
                    kabupatenStats[kabupaten] = 0;
                }
                kabupatenStats[kabupaten]++;
            }
        });

        console.log('Kabupaten dengan data:', Object.keys(kabupatenStats).length);
        console.log('Top kabupaten:', Object.entries(kabupatenStats).sort((a,b) => b[1]-a[1]).slice(0, 5));

        const markerBounds = [];
        let markerCount = 0;

        // Tambahkan markers untuk kabupaten yang ada datanya
        for (const [kabupaten, location] of Object.entries(kabupatenLocations)) {
            const count = kabupatenStats[kabupaten] || 0;
            
            if (count > 0) {
                // Hitung total dari SEMUA menu untuk kabupaten ini
                let totalAllMenus = 0;
                for (const menuId in CSV_DATA) {
                    if (menuId === 'jaksa_garda') continue;
                    const data = CSV_DATA[menuId] || [];
                    const kabData = data.filter(row => {
                        let kab = row['Kabupaten/Kota'] || row.Kabupaten || '';
                        if (!kab) {
                            const satker = row['Nama Satker'] || '';
                            for (const k of kabupatenList) {
                                if (satker.toUpperCase().includes(k.toUpperCase())) {
                                    kab = k;
                                    break;
                                }
                            }
                        }
                        return kab.trim() === kabupaten;
                    });
                    totalAllMenus += kabData.length;
                }
                
                const marker = L.circleMarker([location.lat, location.lng], {
                    radius: Math.min(totalAllMenus / 20, 25) + 5,
                    fillColor: '#22d3ee',
                    color: '#fff',
                    weight: 2,
                    opacity: 1,
                    fillOpacity: 0.7
                });

                const menuLabel = getMenuLabel(currentMenuId);
                marker.bindPopup(`
                    <div style="color: #000; min-width: 180px;">
                        <b style="font-size: 14px;">${kabupaten}</b><br>
                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd;">
                            <div style="font-size: 12px; color: #666;">Menu Aktif:</div>
                            <b style="color: #0891b2;">${menuLabel}: ${count.toLocaleString('id-ID')}</b>
                        </div>
                        <div style="margin-top: 4px; font-size: 11px; color: #999;">
                            Total Semua: <b style="color: #333;">${totalAllMenus.toLocaleString('id-ID')}</b> data
                        </div>
                        <div style="margin-top: 8px; font-size: 10px; color: #0891b2;">
                            â–¸ Klik untuk lihat detail
                        </div>
                    </div>
                `);

                marker.on('click', () => {
                    updateRegionStatsSimple(kabupaten, totalAllMenus);
                });

                marker.addTo(markersLayer);
                markerBounds.push([location.lat, location.lng]);
                markerCount++;
            }
        }

        console.log('Markers ditambahkan:', markerCount);

        // Zoom peta ke area dengan markers
        if (markerBounds.length > 0) {
            console.log('Zoom map ke', markerBounds.length, 'markers');
            mapInstance.fitBounds(markerBounds, { padding: [50, 50] });
        } else {
            console.warn('âš ï¸ Tidak ada markers untuk ditampilkan');
        }

        // Set default region (kabupaten dengan data terbanyak dari menu aktif)
        const sortedKab = Object.entries(kabupatenStats)
            .sort((a, b) => b[1] - a[1]);
        
        if (sortedKab.length > 0) {
            const [topKab, topCount] = sortedKab[0];
            // Update dengan data dari semua menu
            updateRegionStatsSimple(topKab, topCount);
        }
        
        console.log('âœ… Map berhasil diupdate!');
    }

    function updateRegionStats(satkerName, stats) {
        document.getElementById('regionName').textContent = satkerName;
        document.getElementById('statJagaBudaya').textContent = stats.jaga_budaya || 0;
        document.getElementById('statPengawasanOrmas').textContent = stats.pengawasan_ormas || 0;
        document.getElementById('statPemantauanLingkungan').textContent = stats.pemantauan_lingkungan || 0;
        document.getElementById('statOrangAsing').textContent = stats.pemantauan_orang_asing || 0;
        document.getElementById('statAsetDesa').textContent = stats.aset_desa || 0;
        document.getElementById('statPenyelewengan').textContent = stats.kasus_penyelewengan || 0;
    }

    function updateRegionStatsSimple(kabupatenName, count) {
        console.log('\nðŸ“ Updating region stats for:', kabupatenName);
        
        document.getElementById('regionName').textContent = kabupatenName;
        
        // Daftar kabupaten untuk matching
        const kabupatenList = [
            'Surabaya', 'Malang', 'Banyuwangi', 'Jember', 'Sidoarjo', 'Gresik', 
            'Mojokerto', 'Kediri', 'Blitar', 'Probolinggo', 'Pasuruan', 'Tulungagung',
            'Madiun', 'Ponorogo', 'Ngawi', 'Bojonegoro', 'Tuban', 'Lamongan',
            'Pacitan', 'Trenggalek', 'Nganjuk', 'Jombang', 'Bondowoso', 'Situbondo',
            'Lumajang', 'Pamekasan', 'Sampang', 'Sumenep', 'Bangkalan', 'Batu', 'Magetan'
        ];
        
        // Hitung data per menu untuk kabupaten ini dari SEMUA menu
        const menuStats = {
            jaga_budaya: 0,
            pengawasan_ormas: 0,
            pemantauan_lingkungan: 0,
            pemantauan_orang_asing: 0,
            aset_desa: 0,
            kasus_penyelewengan: 0
        };
        
        for (const menuId in CSV_DATA) {
            if (menuId === 'jaksa_garda') continue; // Skip jaksa_garda
            
            const data = CSV_DATA[menuId] || [];
            
            // Filter data untuk kabupaten ini
            const kabData = data.filter(row => {
                // Try direct kabupaten column first
                let kabupaten = row['Kabupaten/Kota'] || row.Kabupaten || '';
                
                // If not found, extract from Nama Satker or Desa
                if (!kabupaten) {
                    const satker = row['Nama Satker'] || '';
                    const desa = row['Desa / Kelurahan'] || row['Desa/Kelurahan'] || '';
                    
                    // Try to match from satker name
                    for (const kab of kabupatenList) {
                        if (satker.toUpperCase().includes(kab.toUpperCase())) {
                            kabupaten = kab;
                            break;
                        }
                    }
                    
                    // If still not found, try from desa name
                    if (!kabupaten) {
                        for (const kab of kabupatenList) {
                            if (desa.toUpperCase().includes(kab.toUpperCase())) {
                                kabupaten = kab;
                                break;
                            }
                        }
                    }
                }
                
                // Check if this row belongs to the selected kabupaten
                return kabupaten.trim() === kabupatenName;
            });
            
            menuStats[menuId] = kabData.length;
        }
        
        console.log('Stats for', kabupatenName, ':', menuStats);
        
        // Update stats display
        document.getElementById('statJagaBudaya').textContent = menuStats.jaga_budaya.toLocaleString('id-ID');
        document.getElementById('statPengawasanOrmas').textContent = menuStats.pengawasan_ormas.toLocaleString('id-ID');
        document.getElementById('statPemantauanLingkungan').textContent = menuStats.pemantauan_lingkungan.toLocaleString('id-ID');
        document.getElementById('statOrangAsing').textContent = menuStats.pemantauan_orang_asing.toLocaleString('id-ID');
        document.getElementById('statAsetDesa').textContent = menuStats.aset_desa.toLocaleString('id-ID');
        document.getElementById('statPenyelewengan').textContent = menuStats.kasus_penyelewengan.toLocaleString('id-ID');
        
        // Calculate total
        const total = Object.values(menuStats).reduce((sum, val) => sum + val, 0);
        console.log('Total data untuk', kabupatenName, ':', total);
    }

    /* ===================== FULL SCREEN TOGGLE ===================== */
    
    function toggleFullScreen(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;
        
        if (!document.fullscreenElement) {
            element.requestFullscreen().catch(err => {
                console.error(`Error attempting to enable fullscreen: ${err.message}`);
            });
        } else {
            document.exitFullscreen();
        }
    }

</script>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

</body>
</html>